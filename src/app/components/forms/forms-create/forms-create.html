<div class="card p-6 bg-blue-100">
    <p-toast></p-toast>

<form class="p-3" [formGroup]="form" novalidate>
  <h2 class="m-0 mb-3">Nueva Atención</h2>

  <!-- Paciente y fecha -->
  <div class="grid gap-3 md:grid-cols-2">
    <div>
      <label class="block mb-1">Paciente *</label>
      <p-autoComplete
        [suggestions]="sugerenciasPacientes"
        (completeMethod)="filtrarPacientes($event)"
        field="name"
        [dropdown]="true"
        [forceSelection]="true"
        [(ngModel)]="pacienteSel"
        [ngModelOptions]="{ standalone: true }"
        (onSelect)="onPacienteSeleccionado($event.value)"
        placeholder="Buscar por nombre y apellido">
        <ng-template let-p pTemplate="item">{{ p.name }} {{ p.last_name }} — {{ p.status }}</ng-template>
        <ng-template let-p pTemplate="selectedItem">{{ p?.name }} {{ p?.last_name }}</ng-template>
      </p-autoComplete>
    </div>
    <div>
      <label class="block mb-1">Fecha *</label>
      <p-datepicker formControlName="fecha" [showIcon]="true" [minDate]="minDate" [readonlyInput]="true"></p-datepicker>
    </div>
  </div>

  <!-- Motivo y signos -->
  <div class="grid gap-3 md:grid-cols-2 mt-3">
    <div>
      <label class="block mb-1">Motivo</label>
      <input pInputText formControlName="motivo" placeholder="Motivo de consulta" />
    </div>
    <div class="grid grid-cols-5 gap-2">
      <input pInputText formControlName="ta" placeholder="TA" />
      <input pInputText type="number" formControlName="fc" placeholder="FC" />
      <input pInputText type="number" formControlName="fr" placeholder="FR" />
      <input pInputText type="number" step="0.1" formControlName="temp" placeholder="Temp" />
      <input pInputText type="number" formControlName="spo2" placeholder="SpO2" />
    </div>
  </div>

  <!-- Diagnósticos -->
  <div class="mt-4">
    <h3 class="m-0">Diagnósticos *</h3>
    <div class="grid gap-2 md:grid-cols-4" formGroupName="diagnosticoForm">
      <p-autoComplete [suggestions]="cie10" (completeMethod)="($event)" [dropdown]="true" [forceSelection]="false"
        placeholder="Código" formControlName="codigo" field="codigo"></p-autoComplete>

      <p-autoComplete [suggestions]="cie10" (completeMethod)="($event)" [dropdown]="true" [forceSelection]="false"
        placeholder="Descripción" formControlName="descripcion" field="descripcion"></p-autoComplete>

      <p-selectButton [options]="tipoDiagOpts" formControlName="tipo"></p-selectButton>

      <p-button label="Añadir" icon="pi pi-plus" (onClick)="addDiagnostico()"></p-button>
    </div>

    <p-table [value]="diagnosticosFA.value" class="mt-2" [showGridlines]="true">
      <ng-template pTemplate="header">
        <tr><th>Código</th><th>Descripción</th><th>Tipo</th><th></th></tr>
      </ng-template>
      <ng-template pTemplate="body" let-d let-i="rowIndex">
        <tr>
          <td>{{ d.codigo }}</td>
          <td>{{ d.descripcion }}</td>
          <td>{{ d.tipo }}</td>
          <td><p-button icon="pi pi-trash" severity="danger" [outlined]="true" (onClick)="removeDiagnostico(i)"></p-button></td>
        </tr>
      </ng-template>
      <ng-template pTemplate="emptymessage"><tr><td colspan="4">Sin diagnósticos</td></tr></ng-template>
    </p-table>
  </div>

  <!-- Procedimientos -->
  <div class="mt-4">
    <h3 class="m-0">Procedimientos</h3>
    <div class="grid gap-2 md:grid-cols-4" formGroupName="procedimientoForm">
      <p-autoComplete [suggestions]="cups" (completeMethod)="($event)" [dropdown]="true" field="codigo"
        placeholder="Código" formControlName="codigo"></p-autoComplete>

      <p-autoComplete [suggestions]="cups" (completeMethod)="($event)" [dropdown]="true" field="descripcion"
        placeholder="Descripción" formControlName="descripcion"></p-autoComplete>

      <input pInputText formControlName="observacion" placeholder="Observación" />

      <p-button label="Añadir" icon="pi pi-plus" (onClick)="addProcedimiento()"></p-button>
    </div>

    <p-table [value]="procedimientosFA.value" class="mt-2" [showGridlines]="true">
      <ng-template pTemplate="header">
        <tr><th>Código</th><th>Descripción</th><th>Observación</th><th></th></tr>
      </ng-template>
      <ng-template pTemplate="body" let-p let-i="rowIndex">
        <tr>
          <td>{{ p.codigo }}</td>
          <td>{{ p.descripcion }}</td>
          <td>{{ p.observacion }}</td>
          <td><p-button icon="pi pi-trash" severity="danger" [outlined]="true" (onClick)="removeProcedimiento(i)"></p-button></td>
        </tr>
      </ng-template>
      <ng-template pTemplate="emptymessage"><tr><td colspan="4">Sin procedimientos</td></tr></ng-template>
    </p-table>
  </div>

  <!-- Receta -->
  <div class="mt-4">
    <h3 class="m-0">Receta</h3>
    <div class="grid gap-2 md:grid-cols-6" formGroupName="recetaForm">
      <p-autoComplete [suggestions]="meds" (completeMethod)="($event)" [dropdown]="true" [forceSelection]="false"
        placeholder="Medicamento" formControlName="medicamento"></p-autoComplete>

      <input pInputText formControlName="presentacion" placeholder="Presentación" />

      <p-selectButton [options]="viasOpts" formControlName="via"></p-selectButton>

      <input pInputText formControlName="dosis" placeholder="Dosis *" />
      <input pInputText formControlName="frecuencia" placeholder="Frecuencia *" />
      <input pInputText formControlName="duracion" placeholder="Duración *" />
    </div>

    <div class="mt-2 grid gap-2 md:grid-cols-6" formGroupName="recetaForm">
      <input class="md:col-span-5" pInputText formControlName="indicaciones" placeholder="Indicaciones" />
      <p-button label="Añadir" icon="pi pi-plus" (onClick)="addRecetaItem()"></p-button>
    </div>

    <p-table [value]="recetaFA.value" class="mt-2" [showGridlines]="true">
      <ng-template pTemplate="header">
        <tr><th>Medicamento</th><th>Vía</th><th>Dosis</th><th>Frecuencia</th><th>Duración</th><th></th></tr>
      </ng-template>
      <ng-template pTemplate="body" let-r let-i="rowIndex">
        <tr>
          <td>{{ r.medicamento }} <small *ngIf="r.presentacion">({{ r.presentacion }})</small></td>
          <td>{{ r.via }}</td>
          <td>{{ r.dosis }}</td>
          <td>{{ r.frecuencia }}</td>
          <td>{{ r.duracion }}</td>
          <td><p-button icon="pi pi-trash" severity="danger" [outlined]="true" (onClick)="removeRecetaItem(i)"></p-button></td>
        </tr>
      </ng-template>
      <ng-template pTemplate="emptymessage"><tr><td colspan="6">Sin medicamentos</td></tr></ng-template>
    </p-table>
  </div>

  <!-- Notas y guardar -->
  <div class="mt-3">
    <label class="block mb-1">Notas</label>
    <textarea pInputTextarea rows="3" formControlName="notas" class="w-full" placeholder="Indicaciones generales"></textarea>
  </div>

  <div class="flex justify-end gap-2 mt-3">
    <p-button label="Guardar" icon="pi pi-check" (onClick)="guardar()"></p-button>
  </div>
</form>


</div>