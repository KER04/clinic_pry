<p-toast />
<p-confirmdialog />

<div class="card p-6 bg-blue-100" >
    <div class="flex justify-between items-center gap-2 mb-3">
        <h2 class="m-0">Agendamiento de Citas</h2>
        <p-button (onClick)="nueva()" label="Nueva cita" icon="pi pi-plus"></p-button>
    </div>

    <!-- Filtros -->
    <div class="grid gap-3 md:grid-cols-3 mb-3">
        <div>
            <label class="block mb-1">Médico</label>
            <p-autoComplete [(ngModel)]="filtroMedico" [suggestions]="sugerenciasMedicos"
                (completeMethod)="filtrarMedicos($event)" [dropdown]="true" [forceSelection]="false"
                placeholder="Todos">
            </p-autoComplete>
        </div>
        <div class="md:col-span-2">
            <label class="block mb-1">Rango de fechas</label>
            <p-datepicker [(ngModel)]="filtroFecha" selectionMode="range" [showIcon]="true"
                [readonlyInput]="true"></p-datepicker>
        </div>
    </div>

    <!-- Tabla -->
    <p-table [value]="(citas$ | async) || []" [paginator]="true" [rows]="10" [rowsPerPageOptions]="[5,10,20]"
        [stripedRows]="true" responsiveLayout="scroll">
        <ng-template pTemplate="header">
            <tr>
                <th>Fecha</th>
                <th>Hora</th>
                <th>Paciente</th>
                <th>Especialidad</th>
                <th>Médico</th>
                <th style="width: 12rem">Acciones</th>
            </tr>
        </ng-template>
        <ng-template pTemplate="body" let-c>
            <tr>
                <td>{{ c.fecha | date:'mediumDate' }}</td>
                <td>{{ c.hora }}</td>
                <td>{{ c.name }} {{ c.last_name }}</td>
                <td>{{ c.specialty }}</td>
                <td>{{ c.medico }}</td>
                <td class="flex gap-2">
                    <p-button size="small" icon="pi pi-pencil" (onClick)="editar(c)" [outlined]="true"
                        label="Editar"></p-button>
                    <p-button size="small" icon="pi pi-trash" severity="danger" (onClick)="confirmarEliminar(c)"
                        [outlined]="true" label="Eliminar"></p-button>
                </td>
            </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
            <tr>
                <td colspan="6">No hay citas para los filtros seleccionados.</td>
            </tr>
        </ng-template>
    </p-table>

    <!-- Diálogo -->
    <p-dialog [(visible)]="visible" [modal]="true" [style]="{ width: '38rem', maxWidth: '95vw' }" [draggable]="false"
        [header]="tituloDialogo">
        <form [formGroup]="form" class="grid gap-3">
            <div class="grid md:grid-cols-2 gap-3">
                <div>
                    <label class="block mb-1">Nombre *</label>
                    <input pInputText formControlName="name" placeholder="Nombre" />
                </div>
                <div>
                    <label class="block mb-1">Apellido *</label>
                    <input pInputText formControlName="last_name" placeholder="Apellido" />
                </div>
            </div>

            <div class="grid md:grid-cols-2 gap-3">
                <div>
                    <label class="block mb-1">Especialidad *</label>
                    <p-autoComplete formControlName="specialty" [suggestions]="sugerenciasEspecialidades"
                        (completeMethod)="filtrarEspecialidades($event)" [dropdown]="true" [forceSelection]="true"
                        placeholder="Selecciona...">
                    </p-autoComplete>
                </div>
                <div>
                    <label class="block mb-1">Médico *</label>
                    <p-autoComplete formControlName="medico" [suggestions]="sugerenciasMedicosForm"
                        (completeMethod)="filtrarMedicosForm($event)" [dropdown]="true" [forceSelection]="true"
                        placeholder="Selecciona...">
                    </p-autoComplete>
                </div>
            </div>

            <div class="grid md:grid-cols-2 gap-3">
                <div>
                    <label class="block mb-1">Fecha *</label>
                    <p-datepicker formControlName="fecha" [showIcon]="true" [minDate]="minDate" [readonlyInput]="true">
                    </p-datepicker>
                </div>
                <div>
                    <label class="block mb-1">Hora (24h) *</label>
                    <p-inputmask formControlName="hora" mask="99:99" placeholder="HH:mm"></p-inputmask>
                </div>
            </div>

            <div class="flex justify-end gap-2 mt-2">
                <p-button [outlined]="true" label="Cancelar" (onClick)="visible=false"></p-button>
                <p-button label="Guardar" icon="pi pi-check" (onClick)="guardar()"></p-button>
            </div>
        </form>
    </p-dialog>
</div>